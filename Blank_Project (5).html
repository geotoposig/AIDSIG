<!DOCTYPE html>
<html lang="fr" dir="ltr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Observatoire G√©ographique R√©gional de Driouch</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- OpenLayers -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ol@10.3.1/ol.css">
    <script src="https://cdn.jsdelivr.net/npm/ol@10.3.1/dist/ol.js"></script>
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <style>
        * {
            box-sizing: border-box;
        }
        
        body {
            margin: 0;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: linear-gradient(135deg, #1e293b 0%, #0f172a 50%, #1e40af 100%);
            min-height: 100vh;
            overflow-x: hidden;
        }

        #map {
            width: 100%;
            height: 100vh;
        }

        /* Professional Glassmorphism */
        .glass {
            backdrop-filter: blur(16px);
            background: rgba(255, 255, 255, 0.08);
            border: 1px solid rgba(255, 255, 255, 0.12);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .glass:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 40px rgba(0, 0, 0, 0.4);
            background: rgba(255, 255, 255, 0.12);
        }

        .glass.active {
            background: rgba(34, 197, 94, 0.2) !important;
            border-color: rgba(34, 197, 94, 0.4) !important;
            box-shadow: 0 0 20px rgba(34, 197, 94, 0.3);
        }

        .glass.selected-point {
            background: rgba(239, 68, 68, 0.2) !important;
            border-color: rgba(239, 68, 68, 0.4) !important;
            box-shadow: 0 0 20px rgba(239, 68, 68, 0.3);
        }

        /* Professional Toolbar */
        .toolbar {
            position: fixed;
            top: 5rem;
            right: 1.5rem;
            display: flex;
            flex-direction: column;
            gap: 1rem;
            z-index: 1000;
            max-width: 56px;
        }

        @media (max-width: 768px) {
            .toolbar {
                top: 4.5rem;
                right: 1rem;
                flex-direction: row;
                flex-wrap: wrap;
                gap: 0.75rem;
                padding: 1rem;
                max-width: none;
            }
            
            .toolbar button {
                flex: 1 1 45%;
                min-width: 52px;
            }
        }

        @media (max-width: 480px) {
            .toolbar {
                flex-direction: row;
                top: auto;
                bottom: 1rem;
                left: 50%;
                transform: translateX(-50%);
                flex-wrap: nowrap;
                gap: 0.5rem;
                padding: 0.75rem;
            }
            
            .toolbar button {
                flex: 0 0 52px;
                padding: 1rem 0.75rem;
            }
        }

        /* Professional Icons */
        .icon-pro {
            filter: drop-shadow(0 1px 2px rgba(0,0,0,0.2));
            transition: all 0.25s ease;
        }

        .glass:hover .icon-pro {
            filter: drop-shadow(0 2px 4px rgba(0,0,0,0.3)) brightness(1.05);
            transform: scale(1.05);
        }

        /* Professional Popup */
        .popup {
            position: absolute;
            z-index: 1001;
            max-width: 380px;
            pointer-events: none;
            opacity: 0;
            transform: translateY(-10px) scale(0.95);
            transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .popup.show {
            opacity: 1;
            transform: translateY(0) scale(1);
            pointer-events: all;
        }

        @media (max-width: 480px) {
            .popup {
                max-width: 340px;
                left: 50% !important;
                top: 50% !important;
                transform: translate(-50%, -50%) scale(0.9);
            }
            
            .popup.show {
                transform: translate(-50%, -50%) scale(1);
            }
        }

        /* Professional Header */
        header {
            backdrop-filter: blur(16px);
            background: rgba(30, 41, 59, 0.9);
            border-bottom: 1px solid rgba(255, 255, 255, 0.08);
        }

        @media (max-width: 640px) {
            header {
                padding: 1rem;
                flex-direction: column;
                gap: 0.75rem;
                height: auto;
            }
        }

        /* Professional Modal */
        .modal {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(12px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .modal.show {
            opacity: 1;
            visibility: visible;
        }

        @media (max-width: 480px) {
            .modal-content {
                margin: 1.5rem;
                max-width: calc(100vw - 3rem);
            }
        }

        /* Professional Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(255,255,255,0.05);
        }

        ::-webkit-scrollbar-thumb {
            background: rgba(255,255,255,0.15);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: rgba(255,255,255,0.25);
        }

        /* Input Focus States */
        input:focus {
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
            border-color: #3b82f6;
        }

        /* Button Gradients */
        .btn-primary {
            background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
        }

        .btn-danger {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        }
    </style>
</head>
<body>

<!-- Header -->
<header class="fixed top-0 right-0 left-0 h-16 z-50 flex items-center justify-between px-6 glass text-white shadow-xl">
    <div class="font-bold text-2xl">üó∫Ô∏è Observatoire G√©ographique de Driouch</div>
    <div class="flex items-center gap-4">
        <span class="px-4 py-2 rounded-xl bg-white/10 backdrop-blur-sm text-lg font-semibold">
            <span id="count">0</span> points
        </span>
    </div>
</header>

<!-- Toolbar -->
<div class="toolbar">
    <button id="drawBtn" class="glass p-4 rounded-xl active-tool relative overflow-hidden group" title="Ajouter un point">
        <div class="w-full h-full absolute inset-0 bg-gradient-to-br from-emerald-400/10 to-teal-400/10 opacity-0 group-hover:opacity-100 transition-all duration-300"></div>
        <svg class="w-6 h-6 icon-pro relative z-10" fill="#22c55e" viewBox="0 0 24 24">
            <circle cx="12" cy="12" r="10"/>
            <path d="M12 2v20M2 12h20"/>
        </svg>
    </button>
    
    <button id="modifyBtn" class="glass p-4 rounded-xl relative overflow-hidden group" title="Modifier le point">
        <div class="w-full h-full absolute inset-0 bg-gradient-to-br from-amber-400/10 to-orange-400/10 opacity-0 group-hover:opacity-100 transition-all duration-300"></div>
        <svg class="w-6 h-6 icon-pro relative z-10" fill="#f59e0b" viewBox="0 0 24 24">
            <path d="M3 17.25V21h3.75L17.81 9.94l-3.75-3.75L3 17.25zM20.71 7.04c.39-.39.39-1.02 0-1.41l-2.34-2.34c-.39-.39-1.02-.39-1.41 0l-1.83 1.83 3.75 3.75 1.83-1.83z"/>
        </svg>
    </button>
    
    <button id="deleteBtn" class="glass p-4 rounded-xl relative overflow-hidden group" title="Supprimer le point">
        <div class="w-full h-full absolute inset-0 bg-gradient-to-br from-red-400/10 to-rose-400/10 opacity-0 group-hover:opacity-100 transition-all duration-300"></div>
        <svg class="w-6 h-6 icon-pro relative z-10" fill="#ef4444" viewBox="0 0 24 24">
            <path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/>
        </svg>
    </button>
    
    <button id="undoBtn" class="glass p-4 rounded-xl relative overflow-hidden group" title="Annuler">
        <div class="w-full h-full absolute inset-0 bg-gradient-to-br from-indigo-400/10 to-violet-400/10 opacity-0 group-hover:opacity-100 transition-all duration-300"></div>
        <svg class="w-6 h-6 icon-pro relative z-10" fill="#6366f1" viewBox="0 0 24 24">
            <path d="M12.5 8c-2.65 0-5.05.99-6.9 2.6L2 7v9h9l-3.62-3.62c1.39-1.16 3.16-1.88 5.12-1.88 3.54 0 6.55 2.31 7.6 5.5l1.5-1c-.98-2.52-3.46-4.38-6.35-4.38z"/>
        </svg>
    </button>
    
    <button id="coordBtn" class="glass p-4 rounded-xl relative overflow-hidden group" title="Saisir les coordonn√©es">
        <div class="w-full h-full absolute inset-0 bg-gradient-to-br from-cyan-400/10 to-emerald-400/10 opacity-0 group-hover:opacity-100 transition-all duration-300"></div>
        <svg class="w-6 h-6 icon-pro relative z-10" fill="#06b6d4" viewBox="0 0 24 24">
            <circle cx="12" cy="12" r="10" stroke="#ffffff" stroke-width="1.5" fill="none"/>
            <path d="M12 2a10 10 0 0 0-8 4h16a10 10 0 0 0-8-4z"/>
        </svg>
    </button>
    
    <button id="exportAllBtn" class="glass p-4 rounded-xl relative overflow-hidden group" title="Exporter tous les points">
        <div class="w-full h-full absolute inset-0 bg-gradient-to-br from-purple-400/10 to-pink-400/10 opacity-0 group-hover:opacity-100 transition-all duration-300"></div>
        <svg class="w-6 h-6 icon-pro relative z-10" fill="#ec4899" viewBox="0 0 24 24">
            <path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"/>
        </svg>
    </button>
</div>

<!-- Map -->
<div id="map"></div>

<!-- Coordinate Modal -->
<div id="coordModal" class="modal">
    <div class="glass p-8 rounded-2xl max-w-md w-full mx-6 modal-content">
        <div class="flex justify-between items-center mb-8">
            <h3 class="font-bold text-2xl text-white">üìç Saisie des coordonn√©es</h3>
            <button id="closeCoordModal" class="text-3xl hover:scale-110 transition-all text-white/80 hover:text-white">√ó</button>
        </div>
        <div class="space-y-6">
            <input id="manualLat" type="number" step="any" placeholder="Latitude" 
                   class="w-full p-4 rounded-xl bg-white/5 border border-white/20 text-white placeholder-white/60 focus:outline-none focus:border-blue-400 focus:ring-2 focus:ring-blue-400/30 transition-all text-lg">
            <input id="manualLon" type="number" step="any" placeholder="Longitude" 
                   class="w-full p-4 rounded-xl bg-white/5 border border-white/20 text-white placeholder-white/60 focus:outline-none focus:border-blue-400 focus:ring-2 focus:ring-blue-400/30 transition-all text-lg">
            <div class="flex gap-4 pt-4">
                <button id="addCoordBtn" class="flex-1 btn-primary hover:from-emerald-600 hover:to-teal-600 rounded-xl py-4 font-semibold text-lg shadow-lg hover:shadow-xl hover:scale-105 transition-all duration-300 text-white">
                    Ajouter le point
                </button>
                <button id="cancelCoordBtn" class="flex-1 glass hover:bg-white/20 rounded-xl py-4 font-semibold text-lg hover:scale-105 transition-all duration-300 text-white">
                    Annuler
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Point Popup Overlay -->
<div id="popupOverlay" class="fixed inset-0 bg-black/70 backdrop-blur-sm z-2000 hidden"></div>
<div id="pointPopup" class="popup glass p-8 rounded-2xl text-white shadow-2xl max-w-sm">
    <div class="flex justify-between items-center mb-8">
        <h3 class="font-bold text-2xl text-white">üìç D√©tails du point</h3>
        <button id="closePopup" class="text-3xl hover:scale-110 transition-all hover:text-red-400">√ó</button>
    </div>
    
    <div class="space-y-6">
        <div>
            <label class="block text-sm font-semibold mb-3 text-white/90">Nom / Adresse du point</label>
            <input id="nameInput" class="w-full p-4 rounded-xl bg-white/5 border border-white/20 text-white placeholder-white/60 focus:outline-none focus:border-emerald-400 focus:ring-2 focus:ring-emerald-400/30 transition-all text-lg font-semibold" placeholder="Entrez le nom du point">
        </div>
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
                <label class="block text-sm font-semibold mb-2 text-white/90">Latitude</label>
                <input id="latInput" type="number" step="any" class="w-full p-4 rounded-xl bg-white/10 border border-blue-400 text-white font-mono text-lg font-bold">
            </div>
            <div>
                <label class="block text-sm font-semibold mb-2 text-white/90">Longitude</label>
                <input id="lonInput" type="number" step="any" class="w-full p-4 rounded-xl bg-white/10 border border-blue-400 text-white font-mono text-lg font-bold">
            </div>
        </div>
        
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 pt-6">
            <button id="saveBtn" class="btn-primary hover:from-emerald-600 hover:to-teal-600 rounded-xl py-4 font-semibold text-lg shadow-lg hover:shadow-xl hover:scale-105 transition-all duration-300 text-white">
                üíæ Enregistrer
            </button>
            <button id="downloadBtn" class="btn-secondary hover:from-blue-600 hover:to-indigo-600 rounded-xl py-4 font-semibold text-lg shadow-lg hover:shadow-xl hover:scale-105 transition-all duration-300 text-white">
                ‚¨áÔ∏è T√©l√©charger
            </button>
        </div>
        
        <div class="text-center pt-4">
            <button id="deleteSingleBtn" class="btn-danger hover:from-red-600 hover:to-rose-600 px-8 py-3 rounded-xl font-semibold text-lg shadow-lg hover:shadow-xl hover:scale-105 transition-all duration-300 text-white">
                üóëÔ∏è Supprimer
            </button>
        </div>
    </div>
</div>

<script>
// ============================================================================
// Variables globales
// ============================================================================
const config = {
    center: ol.proj.fromLonLat([-3.3884, 34.9767]),
    initialZoom: 11,
    provinceUrl: 'https://raw.githubusercontent.com/geotoposig/AIDSIG/refs/heads/main/PROVINCE_DRIOUCH.geojson',
    communesUrl: 'https://raw.githubusercontent.com/geotoposig/AIDSIG/refs/heads/main/COMMUNES_DRIOUCH.geojson'
};

let map, pointSource, pointLayer, currentFeature = null;
let activeTool = null, interactions = {};
let popup, popupOverlay;

// ============================================================================
// Initialisation de la carte et des couches
// ============================================================================
function initMap() {
    const sources = {
        googleSat: new ol.layer.Tile({
            source: new ol.source.XYZ({
                url: 'https://mt1.google.com/vt/lyrs=s&x={x}&y={y}&z={z}',
                maxZoom: 20
            })
        }),
        googleLabels: new ol.layer.Tile({
            source: new ol.source.XYZ({
                url: 'https://mt1.google.com/vt/lyrs=h&x={x}&y={y}&z={z}',
                maxZoom: 20
            })
        }),
        province: new ol.source.Vector({ url: config.provinceUrl, format: new ol.format.GeoJSON() }),
        communes: new ol.source.Vector({ url: config.communesUrl, format: new ol.format.GeoJSON() }),
        points: new ol.source.Vector()
    };

    const styles = {
        province: new ol.style.Style({
            stroke: new ol.style.Stroke({ color: '#000', width: 4 }),
            fill: new ol.style.Fill({ color: 'rgba(0,0,0,0)' })
        }),
        commune: feature => [
            new ol.style.Style({
                stroke: new ol.style.Stroke({ color: '#ef4444', width: 2 }),
                fill: new ol.style.Fill({ color: 'rgba(239,68,68,0.1)' })
            }),
            new ol.style.Style({
                text: new ol.style.Text({
                    text: feature.get('CommuneMun') || 'Non d√©fini',
                    font: '500 14px Inter',
                    fill: new ol.style.Fill({ color: '#ef4444' }),
                    stroke: new ol.style.Stroke({ color: '#fff', width: 3 })
                })
            })
        ],
        point: function(feature) {
            const isSelected = feature.get('selected') || false;
            return new ol.style.Style({
                image: new ol.style.Circle({
                    radius: isSelected ? 16 : 12,
                    fill: new ol.style.Fill({ color: isSelected ? '#ef4444' : '#22c55e' }),
                    stroke: new ol.style.Stroke({ color: '#ffffff', width: isSelected ? 5 : 3 })
                }),
                text: new ol.style.Text({
                    text: feature.get('name') || 'üìç',
                    offsetY: -25,
                    font: '600 14px Inter',
                    fill: new ol.style.Fill({ color: '#ffffff' }),
                    stroke: new ol.style.Stroke({ color: '#000000', width: 3 })
                })
            });
        }
    };

    // Cr√©ation des couches
    const provinceLayer = new ol.layer.Vector({ source: sources.province, style: styles.province });
    const communeLayer = new ol.layer.Vector({ source: sources.communes, style: styles.commune });
    
    pointSource = sources.points;
    pointLayer = new ol.layer.Vector({ source: pointSource, style: styles.point });

    // Cr√©ation de la carte
    map = new ol.Map({
        target: 'map',
        layers: [sources.googleSat, sources.googleLabels, provinceLayer, communeLayer, pointLayer],
        view: new ol.View({ center: config.center, zoom: config.initialZoom })
    });

    // Zoom automatique sur la r√©gion
    Promise.all([
        new Promise(resolve => sources.province.once('featuresloadend', resolve)),
        new Promise(resolve => sources.communes.once('featuresloadend', resolve))
    ]).then(() => {
        const extent = ol.extent.extend(sources.province.getExtent(), sources.communes.getExtent());
        map.getView().fit(extent, { padding: [20, 20, 200, 20], duration: 2000 });
    });

    initInteractions();
    initEventListeners();
    updatePointCount();
}

// ============================================================================
// Gestion des outils et interactions
// ============================================================================
function setActiveTool(toolId) {
    document.querySelectorAll('.toolbar button').forEach(btn => btn.classList.remove('active'));
    if (toolId) document.getElementById(toolId).classList.add('active');
    activeTool = toolId;
}

function initInteractions() {
    // Interaction de s√©lection
    interactions.select = new ol.interaction.Select({
        layers: [pointLayer],
        style: new ol.style.Style({
            image: new ol.style.Circle({
                radius: 18,
                fill: new ol.style.Fill({ color: '#ef4444' }),
                stroke: new ol.style.Stroke({ color: '#ffffff', width: 5 })
            })
        })
    });
    map.addInteraction(interactions.select);

    interactions.select.on('select', function(e) {
        e.selected.forEach(f => f.set('selected', true));
        e.deselected.forEach(f => f.set('selected', false));
        pointLayer.changed();
    });

    // Clic simple pour afficher popup
    map.on('singleclick', function(evt) {
        const feature = map.forEachFeatureAtPixel(evt.pixel, function(feature) {
            return feature;
        }, { layerFilter: f => f === pointLayer });

        if (feature) {
            showPointPopup(feature);
        } else {
            hidePointPopup();
        }
    });
}

function toggleDraw() {
    deactivateAllInteractions();
    interactions.draw = new ol.interaction.Draw({ source: pointSource, type: 'Point' });
    map.addInteraction(interactions.draw);
    interactions.draw.on('drawend', handleDrawEnd);
    setActiveTool('drawBtn');
}

function toggleModify() {
    deactivateAllInteractions();
    interactions.modify = new ol.interaction.Modify({ source: pointSource });
    map.addInteraction(interactions.modify);
    setActiveTool('modifyBtn');
}

function deactivateAllInteractions() {
    Object.values(interactions).forEach(interaction => {
        if (interaction && map.getInteractions().getArray().includes(interaction)) {
            map.removeInteraction(interaction);
        }
    });
}

// ============================================================================
// Gestion des points et popups
// ============================================================================
function handleDrawEnd(e) {
    currentFeature = e.feature;
    const coords = e.feature.getGeometry().getCoordinates();
    const lonLat = ol.proj.toLonLat(coords);
    
    showPointPopup(currentFeature, lonLat[1], lonLat[0]);
    map.removeInteraction(interactions.draw);
    setActiveTool(null);
}

function showPointPopup(feature, lat = null, lon = null) {
    currentFeature = feature;
    popupOverlay.classList.remove('hidden');
    popup.classList.add('show');
    
    const coords = feature.getGeometry().getCoordinates();
    const lonLat = ol.proj.toLonLat(coords);
    
    document.getElementById('nameInput').value = feature.get('name') || '';
    document.getElementById('latInput').value = lat || lonLat[1].toFixed(6);
    document.getElementById('lonInput').value = lon || lonLat[0].toFixed(6);
    
    // Positionnement du popup pr√®s du point
    const pixel = map.getPixelFromCoordinate(coords);
    popup.style.left = (pixel[0] + 20) + 'px';
    popup.style.top = (pixel[1] - 20) + 'px';
    
    map.getView().animate({
        center: coords,
        duration: 500
    });
}

function hidePointPopup() {
    popupOverlay.classList.add('hidden');
    popup.classList.remove('show');
    currentFeature = null;
}

function savePointChanges() {
    if (!currentFeature) return;
    
    const name = document.getElementById('nameInput').value.trim();
    const lat = parseFloat(document.getElementById('latInput').value);
    const lon = parseFloat(document.getElementById('lonInput').value);
    
    if (!name) {
        alert('Veuillez entrer un nom pour le point');
        return;
    }
    
    if (isNaN(lat) || isNaN(lon) || lat < -90 || lat > 90 || lon < -180 || lon > 180) {
        alert('Coordonn√©es invalides');
        return;
    }
    
    currentFeature.set('name', name);
    currentFeature.getGeometry().setCoordinates(ol.proj.fromLonLat([lon, lat]));
    pointLayer.changed();
    updatePointCount();
    hidePointPopup();
}

function downloadSinglePoint() {
    if (!currentFeature) return;
    
    const coords = ol.proj.toLonLat(currentFeature.getGeometry().getCoordinates());
    const data = {
        name: currentFeature.get('name'),
        lat: coords[1],
        lon: coords[0]
    };
    
    const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `point-${data.name || 'sans-nom'}-${Date.now()}.json`;
    a.click();
    URL.revokeObjectURL(url);
}

function deleteSelected() {
    if (interactions.select.getFeatures().getLength() > 0) {
        interactions.select.getFeatures().getArray().forEach(f => pointSource.removeFeature(f));
        interactions.select.getFeatures().clear();
        updatePointCount();
    } else if (currentFeature) {
        pointSource.removeFeature(currentFeature);
        updatePointCount();
        hidePointPopup();
    }
}

// ============================================================================
// Export et import
// ============================================================================
function exportAllPoints() {
    const features = pointSource.getFeatures().map(f => {
        const coords = ol.proj.toLonLat(f.getGeometry().getCoordinates());
        return { name: f.get('name'), lat: coords[1], lon: coords[0] };
    });

    const zip = new JSZip();
    zip.file('points.geojson', JSON.stringify({
        type: 'FeatureCollection',
        features: features.map(f => ({
            type: 'Feature',
            properties: { name: f.name },
            geometry: { type: 'Point', coordinates: [f.lon, f.lat] }
        }))
    }, null, 2));

    zip.file('points.csv', 'Nom,Latitude,Longitude\n' + features.map(f => `"${f.name}",${f.lat},${f.lon}`).join('\n'));
    
    zip.generateAsync({ type: "blob" }).then(content => {
        const link = document.createElement("a");
        link.href = URL.createObjectURL(content);
        link.download = `driouch-points-${new Date().toISOString().slice(0,10)}.zip`;
        link.click();
    });
}

function updatePointCount() {
    document.getElementById('count').textContent = pointSource.getFeatures().length;
}

// ============================================================================  
// Gestion de la fen√™tre modale des coordonn√©es
// ============================================================================
function openCoordModal() {
    document.getElementById('coordModal').classList.add('show');
    setActiveTool(null);
}

function addFromCoordinates() {
    const lat = parseFloat(document.getElementById('manualLat').value);
    const lon = parseFloat(document.getElementById('manualLon').value);
    
    if (isNaN(lat) || isNaN(lon) || lat < -90 || lat > 90 || lon < -180 || lon > 180) {
        alert('‚ùå Coordonn√©es invalides');
        return;
    }
    
    currentFeature = new ol.Feature({
        geometry: new ol.geom.Point(ol.proj.fromLonLat([lon, lat])),
        name: ''
    });
    
    document.getElementById('coordModal').classList.remove('show');
    showPointPopup(currentFeature, lat, lon);
}

// ============================================================================
// Liaison des √©v√©nements
// ============================================================================
function initEventListeners() {
    // Boutons d'outils
    document.getElementById('drawBtn').onclick = toggleDraw;
    document.getElementById('modifyBtn').onclick = toggleModify;
    document.getElementById('deleteBtn').onclick = deleteSelected;
    document.getElementById('coordBtn').onclick = openCoordModal;
    document.getElementById('exportAllBtn').onclick = exportAllPoints;
    
    // Popup du point
    document.getElementById('saveBtn').onclick = savePointChanges;
    document.getElementById('downloadBtn').onclick = downloadSinglePoint;
    document.getElementById('deleteSingleBtn').onclick = deleteSelected;
    document.getElementById('closePopup').onclick = hidePointPopup;
    
    // Modal des coordonn√©es
    document.getElementById('closeCoordModal').onclick = () => document.getElementById('coordModal').classList.remove('show');
    document.getElementById('cancelCoordBtn').onclick = () => document.getElementById('coordModal').classList.remove('show');
    document.getElementById('addCoordBtn').onclick = addFromCoordinates;
    
    // Overlay du popup
    popupOverlay = document.getElementById('popupOverlay');
    popup = document.getElementById('pointPopup');
    popupOverlay.onclick = hidePointPopup;
    
    // Fermeture avec ESC
    document.addEventListener('keydown', e => {
        if (e.key === 'Escape') {
            hidePointPopup();
            document.getElementById('coordModal').classList.remove('show');
        }
    });
}

// Chargement de JSZip
const jszipScript = document.createElement('script');
jszipScript.src = 'https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js';
document.head.appendChild(jszipScript);

// D√©marrage de l'application
window.addEventListener('DOMContentLoaded', initMap);
</script>

</body>
</html>
